<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Everest Korean Tutor</title>

    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8f9fa">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css?v=2.5">
</head>

<body>

    <header>
        <h1>Everest Korean</h1>
        <p class="subtitle">네팔 직원을 위한 AI 한국어 선생님</p>
    </header>

    <div id="debug-log"
        style="position:fixed; top:0; left:0; right:0; background:red; color:white; padding:10px; z-index:99999; display:none; white-space:pre-wrap;">
    </div>

    <div class="container">
        <!-- Category Dropdown System -->
        <div class="category-wrapper">
            <div id="category-header" class="category-header" onclick="toggleCategoryMenu()">
                <span id="current-category-label" class="current-category">All Categories</span>
                <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
            </div>

            <div id="category-dropdown" class="category-dropdown">
                <!-- Categories injected here -->
            </div>
        </div>

        <!-- Content Grid -->
        <div id="card-container" class="card-grid">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading Data... (v2.6)
            </div>
        </div>

        <div style="text-align:center; margin-top:20px; color:#aaa; font-size:12px;">App Version 2.6</div>
    </div>

    <!-- Scripts -->
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const debugEl = document.getElementById('debug-log');
            if (debugEl) {
                debugEl.style.display = 'block';
                debugEl.textContent += `Error: ${msg}\nLine: ${lineNo}\n`;
            }
            return false;
        };

        // Initialize App
        console.log('App Script Starting...');
        // alert('System Check: App Started'); // Uncomment for aggressive debugging if needed

        // App State
        const state = {
            data: [],
            categories: ['All'],
            activeCategory: 'All',
            isListening: false
        };

        // Google Sheet Published CSV URL
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRo4iD3re1NbdQt7ok1xP41jIOZ_LTBciO7oBWLHaZR7cNajUlTZvlwONDRKIlZlm6UThP8zxDK5pmO/pub?output=csv';

        // Fallback Data (Internal backup)
        const FALLBACK_DATA = [
            { Category: '인사/입장', Situation: '환영', Korean: 'APP ERROR: Google Sheet 연결 실패', Pronunciation: 'Connection Failed', Nepali: '잠시 후 다시 시도해주세요.' },
            { Category: '인사/입장', Situation: '환영', Korean: '어서 오세요.', Pronunciation: '오소 오세요', Nepali: 'स्वागत छ।' },
            { Category: '주문', Situation: '주문', Korean: '주문하시겠어요?', Pronunciation: 'जुमुन 하सि게स्सयो?', Nepali: 'अर्डर लिनू?' }
        ];

        // DOM Elements
        const categoryHeader = document.getElementById('category-header');
        const categoryLabel = document.getElementById('current-category-label');
        const categoryDropdown = document.getElementById('category-dropdown');
        const cardContainer = document.getElementById('card-container');

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. In-App Browser Escape Logic (KakaoTalk, Line, etc.)
            const userAgent = navigator.userAgent.toLowerCase();
            const isAndroid = /android/i.test(navigator.userAgent);

            if (userAgent.match(/kakaotalk|line|inapp|naver|instagram|facebook/i)) {
                if (isAndroid) {
                    // Android: Attempt to force open Chrome using Intent Scheme
                    // Format: intent://<URL>#Intent;scheme=https;package=com.android.chrome;end
                    const cleanUrl = location.href.replace(/^https?:\/\//, '');
                    location.href = `intent://${cleanUrl}#Intent;scheme=https;package=com.android.chrome;end`;
                    return; // Stop execution to let redirect happen
                } else {
                    // iOS/Others: Show Alert Guide
                    alert('⚠️ 음성 인식이 지원되지 않는 브라우저입니다.\n\n[해결 방법]\n화면 우측 상단 [⋮] 또는 [⋯] 메뉴를 누르고\n"다른 브라우저로 열기"를 선택해주세요.');
                }
            }

            await loadData();
            renderCategories();
            renderCards();

            // Click outside to close menu
            document.addEventListener('click', (e) => {
                const wrapper = document.querySelector('.category-wrapper');
                if (wrapper && !wrapper.contains(e.target)) {
                    categoryDropdown.classList.remove('show');
                    categoryHeader.classList.remove('open');
                }
            });
        });

        // Toggle Menu
        window.toggleCategoryMenu = function () {
            categoryDropdown.classList.toggle('show');
            categoryHeader.classList.toggle('open');
        }

        // Data Loading
        async function loadData() {
            // Safety Valve: Force fallback after 3 seconds if data is stuck
            const safetyTimeout = setTimeout(() => {
                console.warn('Data loading timed out (3s limit reached)');
                useFallbackData();
            }, 3000);

            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();

                // Clear timeout if fetch succeeds
                clearTimeout(safetyTimeout);

                if (typeof Papa === 'undefined') {
                    throw new Error('PapaParse library not loaded');
                }

                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        // Clear timeout if parsing completes successfully
                        clearTimeout(safetyTimeout);

                        if (results.data && results.data.length > 0) {
                            // Map Google Sheet columns to App internal state
                            const mappedData = results.data.map(row => ({
                                Category: row['대분류'] || '기타',
                                Situation: row['상황'] || '',
                                Korean: row['한국어'] || '',
                                Pronunciation: row['발음(नेपाली लिपि)'] || '',
                                Nepali: row['네팔어'] || ''
                            })).filter(item => item.Korean); // Filter out empty rows

                            if (mappedData.length > 0) {
                                state.data = mappedData;
                                initCategories();
                                renderCategories();
                                renderCards();
                                return;
                            }
                        }
                        // If we get here, parsing failed or data was empty
                        throw new Error('Parsed data is empty');
                    },
                    error: function (err) {
                        console.error('Papa Parse Error:', err);
                        useFallbackData();
                    }
                });
            } catch (error) {
                console.warn('Google Sheet fetch failed, falling back to local data.', error);
                useFallbackData();
            }
        }

        function useFallbackData() {
            state.data = FALLBACK_DATA;
            initCategories();
            renderCategories();
            renderCards();

            // Show a toast or small alert about the error
            const msg = document.createElement('div');
            msg.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:30px; z-index:9999; font-size:12px;';
            msg.textContent = 'Data loaded from backup (Connection Issue)';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 5000);
        }

        function initCategories() {
            const uniqueCats = [...new Set(state.data.map(item => item.Category).filter(Boolean))];
            state.categories = ['All', ...uniqueCats];
        }

        // Rendering Categories (Dropdown Logic)
        function renderCategories() {
            if (!categoryDropdown) return;
            categoryDropdown.innerHTML = '';

            // Update Header Label
            categoryLabel.textContent = state.activeCategory === 'All' ? 'All Categories (전체 보기)' : state.activeCategory;

            state.categories.forEach(cat => {
                const chip = document.createElement('div');
                chip.className = `chip ${state.activeCategory === cat ? 'active' : ''}`;
                chip.textContent = cat;
                chip.onclick = (e) => {
                    e.stopPropagation(); // Prevent bubbling
                    state.activeCategory = cat;
                    renderCategories(); // Update active class
                    renderCards();
                    // Close menu
                    categoryDropdown.classList.remove('show');
                    categoryHeader.classList.remove('open');
                };
                categoryDropdown.appendChild(chip);
            });
        }

        function renderCards() {
            if (!cardContainer) return;
            cardContainer.innerHTML = '';
            const filteredData = state.activeCategory === 'All'
                ? state.data
                : state.data.filter(item => item.Category === state.activeCategory);

            if (filteredData.length === 0) {
                cardContainer.innerHTML = '<div class="loading">No items found in this category.</div>';
                return;
            }

            filteredData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="sentence-korean">${item.Korean}</div>
                    <div class="sentence-pronunciation">${item.Pronunciation || ''}</div>
                    <div class="sentence-meaning">${item.Nepali}</div>
                    <div class="card-actions">
                        <button class="btn-icon play-btn" onclick="speakText('${item.Korean}', this)" aria-label="Listen" style="background:#e74c3c; color:white;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </button>
                        <button class="btn-icon mic-btn" id="mic-${index}" onclick="startListening('${item.Korean}', 'mic-${index}')" aria-label="Speak" style="background:#2ecc71; color:white;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                        </button>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
        }

        // TTS (Text to Speech)
        window.speakText = function (text, btnElement) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.9;

                // Button animation
                const icon = btnElement.querySelector('svg');
                icon.style.opacity = '0.5';

                utterance.onend = () => {
                    icon.style.opacity = '1';
                };

                utterance.onerror = (e) => {
                    console.error('TTS Error:', e);
                    alert('음성 재생 오류 (Please use Chrome Browser)');
                    icon.style.opacity = '1';
                };

                window.speechSynthesis.speak(utterance);
            } else {
                alert('음성 기능을 지원하지 않는 브라우저입니다.\n(Chrome 또는 Safari를 사용해주세요.)');
            }
        };

        // STT (Speech to Text)
        window.startListening = function (targetText, btnId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('이 브라우저는 음성 인식을 지원하지 않습니다. Chrome을 사용해주세요.');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const btn = document.getElementById(btnId);

            recognition.onstart = () => {
                btn.classList.add('recording');
            };

            recognition.onend = () => {
                btn.classList.remove('recording');
            };

            recognition.onresult = (event) => {
                const script = event.results[0][0].transcript;
                const accuracy = compareStrings(script, targetText);

                // Simple feedback alert for now
                if (accuracy > 0.7) {
                    alert(`धेरै राम्रो! (Great!)\nतपाईंको उच्चारण: "${script}"\n(Your pronunciation is correct)`);
                } else {
                    alert(`फेरि प्रयास गर्नुहोस् (Try again)\n\nतपाईंको उच्चारण (You said): "${script}"\nसही उत्तर (Correct): "${targetText}"`);
                }
            };

            recognition.start();
        };

        // Simple string similarity for feedback (Levenshtein distance based simplified)
        function compareStrings(s1, s2) {
            s1 = s1.replace(/\s+/g, '').replace(/[.,?!]/g, '');
            s2 = s2.replace(/\s+/g, '').replace(/[.,?!]/g, '');

            if (s1 === s2) return 1.0;
            if (s1.includes(s2) || s2.includes(s1)) return 0.8;
            return 0.5; // Placeholder logic
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

</body>

</html>